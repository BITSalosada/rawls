<?xml version="1.0" encoding="UTF-8" standalone="no"?>
<databaseChangeLog logicalFilePath="dummy" xmlns="http://www.liquibase.org/xml/ns/dbchangelog" xmlns:ext="http://www.liquibase.org/xml/ns/dbchangelog-ext" xmlns:xsi="http://www.w3.org/2001/XMLSchema-instance" xsi:schemaLocation="http://www.liquibase.org/xml/ns/dbchangelog-ext http://www.liquibase.org/xml/ns/dbchangelog/dbchangelog-ext.xsd http://www.liquibase.org/xml/ns/dbchangelog http://www.liquibase.org/xml/ns/dbchangelog/dbchangelog-3.4.xsd">

    <changeSet logicalFilePath="dummy" author="mbemis" id="refactor-entity-attribute-ids">

        <sql stripComments="true">
            alter table ATTRIBUTE drop foreign key fk_attribute_entity_ref;
            alter table ENTITY_ATTRIBUTE drop foreign key fk_ent_attr_entity;
            alter table ENTITY_ATTRIBUTE drop foreign key fk_ent_attr_attribute;
            alter table SUBMISSION drop foreign key fk_sub_entity;
            alter table SUBMISSION_VALIDATION drop foreign key fk_sub_validation_val;
            alter table WORKFLOW drop foreign key fk_wf_entity;
            alter table WORKFLOW_FAILURE drop foreign key fk_wf_failure_entity;
            alter table WORKSPACE_ATTRIBUTE drop foreign key fk_ws_attr_attribute;

            alter table ATTRIBUTE change id old_id bigint(20) unsigned not null;
            alter table ATTRIBUTE add column id binary(16);
            update ATTRIBUTE set id=unhex(replace(uuid(), '-', ''));
            alter table ATTRIBUTE drop primary key;
            alter table ATTRIBUTE modify id binary(16) not null primary key;
            alter table ATTRIBUTE modify old_id bigint(20) unsigned null;

            alter table ENTITY change id old_id bigint(20) unsigned not null;
            alter table ENTITY add column id binary(16);
            update ENTITY set id=unhex(replace(uuid(), '-', ''));
            alter table ENTITY drop primary key;
            alter table ENTITY modify id binary(16) not null primary key;
            alter table ENTITY modify old_id bigint(20) unsigned null;

            alter table ATTRIBUTE change value_entity_ref old_value_entity_ref bigint(20) unsigned;
            alter table ATTRIBUTE add column value_entity_ref binary(16);
            update ATTRIBUTE a join ENTITY e on a.old_value_entity_ref=e.old_id set a.value_entity_ref=e.id;
            alter table ATTRIBUTE add foreign key (value_entity_ref) references ENTITY(id);

            alter table ENTITY_ATTRIBUTE change entity_id old_entity_id bigint(20) unsigned not null;
            alter table ENTITY_ATTRIBUTE add column entity_id binary(16);
            update ENTITY_ATTRIBUTE ea join ENTITY e on ea.old_entity_id=e.old_id set ea.entity_id=e.id;
            alter table ENTITY_ATTRIBUTE change entity_id entity_id binary(16) not null;
            alter table ENTITY_ATTRIBUTE add foreign key (entity_id) references ENTITY(id);
            alter table ENTITY_ATTRIBUTE modify old_entity_id bigint(20) unsigned null;

            alter table ENTITY_ATTRIBUTE change attribute_id old_attribute_id bigint(20) unsigned not null;
            alter table ENTITY_ATTRIBUTE add column attribute_id binary(16);
            update ENTITY_ATTRIBUTE ea join ATTRIBUTE a on ea.old_attribute_id=a.old_id
            set ea.attribute_id=a.id;
            alter table ENTITY_ATTRIBUTE change attribute_id attribute_id binary(16) not null;
            alter table ENTITY_ATTRIBUTE add foreign key (attribute_id) references ATTRIBUTE(id);
            alter table ENTITY_ATTRIBUTE drop primary key;
            alter table ENTITY_ATTRIBUTE modify old_attribute_id bigint(20) unsigned null;
            alter table ENTITY_ATTRIBUTE modify attribute_id binary(16) primary key;

            alter table SUBMISSION change entity_id old_entity_id bigint(20) unsigned;
            alter table SUBMISSION add column entity_id binary(16);
            update SUBMISSION s join ENTITY e on s.old_entity_id=e.old_id set s.entity_id=e.id;
            alter table SUBMISSION drop index fk_sub_entity;
            alter table SUBMISSION add foreign key (entity_id) references ENTITY(id)
            on delete no action on update no action;

            alter table SUBMISSION_VALIDATION change value_id old_value_id bigint(20) unsigned;
            alter table SUBMISSION_VALIDATION add column value_id binary(16);
            update SUBMISSION_VALIDATION sv join ATTRIBUTE a on sv.old_value_id=a.old_id set sv.value_id=a.id;
            alter table SUBMISSION_VALIDATION add foreign key (value_id) references ATTRIBUTE(id)
            on delete no action on update no action;

            alter table WORKFLOW change entity_id old_entity_id bigint(20) unsigned;
            alter table WORKFLOW add column entity_id binary(16);
            update WORKFLOW w join ENTITY e on w.old_entity_id=e.old_id set w.entity_id=e.id;
            alter table WORKFLOW drop index idx_workflow_entity;
            alter table WORKFLOW add foreign key (entity_id) references ENTITY(id)
            on delete no action on update no action;

            alter table WORKFLOW_FAILURE change entity_id old_entity_id bigint(20) unsigned;
            alter table WORKFLOW_FAILURE add column entity_id binary(16);
            update WORKFLOW_FAILURE wf join ENTITY e on wf.old_entity_id=e.old_id set wf.entity_id=e.id;
            alter table WORKFLOW_FAILURE add foreign key (entity_id) references ENTITY(id)
            on delete no action on update no action;

            alter table WORKSPACE_ATTRIBUTE change attribute_id old_attribute_id bigint(20) unsigned not null;
            alter table WORKSPACE_ATTRIBUTE add column attribute_id binary(16);
            update WORKSPACE_ATTRIBUTE wa join ATTRIBUTE a on wa.old_attribute_id=a.old_id
            set wa.attribute_id=a.id;
            alter table WORKSPACE_ATTRIBUTE change attribute_id attribute_id binary(16) not null;
            alter table WORKSPACE_ATTRIBUTE add foreign key (attribute_id) references ATTRIBUTE(id);
            alter table WORKSPACE_ATTRIBUTE drop primary key;
            alter table WORKSPACE_ATTRIBUTE modify old_attribute_id bigint(20) unsigned null;
            alter table WORKSPACE_ATTRIBUTE modify attribute_id binary(16) primary key;
        </sql>

    </changeSet>

</databaseChangeLog>
